{% extends "admin/base.html" %}

{% block title %}Operations Center — {{ site_header }}{% endblock %}

{% block content %}
<div class="p-4 sm:p-6" x-data="opsCenter()" x-init="init()">
    <!-- Header -->
    <div class="flex items-center justify-between mb-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Operations Center</h1>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-0.5">Overview, Activity, Stream & Runtime</p>
        </div>
        <div class="flex items-center gap-2">
            <a :href="opsUrl()" class="inline-flex items-center gap-2 px-3 py-1.5 text-sm font-medium rounded-lg transition-colors"
               :class="realtimeEnabled ? 'bg-green-500/20 text-green-700 dark:text-green-400' : 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300'">
                <span class="w-2 h-2 rounded-full" :class="realtimeEnabled ? 'bg-green-500 animate-pulse' : 'bg-gray-400'"></span>
                <span x-text="realtimeEnabled ? 'Live' : 'Paused'"></span>
            </a>
            <button @click="toggleRealtime()" x-show="false"></button>
            <button @click="refreshCurrent()" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors">
                <svg class="w-4 h-4" :class="{'animate-spin': loading}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg>
                Refresh
            </button>
        </div>
    </div>

    <!-- Tabs -->
    <div class="flex items-center gap-1 mb-4 bg-gray-100 dark:bg-gray-800 p-1 rounded-xl w-fit">
        <a :href="opsUrl({ tab: 'overview' })" @click.prevent="goTo({ tab: 'overview' })" :class="tab === 'overview' ? 'bg-white dark:bg-gray-700 shadow-sm text-gray-900 dark:text-white' : 'text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300'"
           class="px-4 py-2 text-sm font-medium rounded-lg transition-all">Overview</a>
        <a :href="opsUrl({ tab: 'activity' })" @click.prevent="goTo({ tab: 'activity' })" :class="tab === 'activity' ? 'bg-white dark:bg-gray-700 shadow-sm text-gray-900 dark:text-white' : 'text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300'"
           class="px-4 py-2 text-sm font-medium rounded-lg transition-all">Activity</a>
        <a :href="opsUrl({ tab: 'stream' })" @click.prevent="goTo({ tab: 'stream' })" :class="tab === 'stream' ? 'bg-white dark:bg-gray-700 shadow-sm text-gray-900 dark:text-white' : 'text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300'"
           class="px-4 py-2 text-sm font-medium rounded-lg transition-all">Stream</a>
        <a :href="opsUrl({ tab: 'runtime' })" @click.prevent="goTo({ tab: 'runtime' })" :class="tab === 'runtime' ? 'bg-white dark:bg-gray-700 shadow-sm text-gray-900 dark:text-white' : 'text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300'"
           class="px-4 py-2 text-sm font-medium rounded-lg transition-all">Runtime</a>
    </div>

    <!-- Content: list or detail full width -->
    <div class="min-h-[400px]">
        <!-- Detail view (selected entity) - full width with Back -->
        <div x-show="selected" x-cloak class="space-y-4">
            <div class="flex items-center gap-2 mb-4">
                <a :href="opsUrl({ selected: null })" @click.prevent="goToSelected({ selected: null })" class="inline-flex items-center gap-1.5 text-sm font-medium text-primary-600 dark:text-primary-400 hover:underline">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
                    Voltar
                </a>
            </div>
            <div id="detail-content" class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
                <!-- Rendered by Alpine -->
                <template x-if="detailKind === 'task'">
                    <div class="p-6" x-data>
                        <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Task</h2>
                        <dl class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm" x-show="detailItem">
                            <div><dt class="text-gray-500 dark:text-gray-400">Task ID</dt><dd class="font-mono" x-text="detailItem && detailItem.task_id"></dd></div>
                            <div><dt class="text-gray-500 dark:text-gray-400">Name</dt><dd x-text="detailItem && detailItem.task_name"></dd></div>
                            <div><dt class="text-gray-500 dark:text-gray-400">Queue</dt><dd><a :href="opsUrl({ tab: 'activity', view: 'tasks', selected: null })" class="text-primary-600 dark:text-primary-400 hover:underline font-mono" x-text="detailItem && detailItem.queue"></a></dd></div>
                            <div><dt class="text-gray-500 dark:text-gray-400">Status</dt><dd><span class="px-2 py-0.5 rounded text-xs font-medium" :class="statusClass(detailItem && detailItem.status)" x-text="detailItem && detailItem.status"></span></dd></div>
                            <div><dt class="text-gray-500 dark:text-gray-400">Worker</dt><dd><a :href="detailItem && detailItem.worker_id ? opsUrl({ tab: 'activity', view: 'workers', selected: detailItem.worker_id }) : '#'" class="text-primary-600 dark:text-primary-400 hover:underline font-mono" x-text="detailItem && detailItem.worker_id"></a></dd></div>
                            <div><dt class="text-gray-500 dark:text-gray-400">Duration</dt><dd x-text="detailItem && detailItem.duration_ms != null ? detailItem.duration_ms + ' ms' : '—'"></dd></div>
                        </dl>
                        <div class="mt-4 flex gap-2" x-show="detailItem && ['FAILURE','CANCELLED'].includes(detailItem.status)">
                            <button @click="action('retry')" class="px-3 py-1.5 text-sm font-medium rounded-lg bg-primary-500 text-white hover:bg-primary-600">Retry</button>
                        </div>
                    </div>
                </template>
                <template x-if="detailKind === 'worker'">
                    <div class="p-6" x-data>
                        <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Worker</h2>
                        <dl class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm" x-show="detailItem">
                            <div><dt class="text-gray-500 dark:text-gray-400">Worker ID</dt><dd class="font-mono truncate" x-text="detailItem && detailItem.worker_id"></dd></div>
                            <div><dt class="text-gray-500 dark:text-gray-400">Status</dt><dd><span class="px-2 py-0.5 rounded text-xs font-medium" :class="detailItem && detailItem.status === 'ONLINE' ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400' : 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400'" x-text="detailItem && detailItem.status"></span></dd></div>
                            <div><dt class="text-gray-500 dark:text-gray-400">Active tasks</dt><dd x-text="detailItem && detailItem.active_tasks"></dd></div>
                            <div><dt class="text-gray-500 dark:text-gray-400">Total processed</dt><dd x-text="detailItem && detailItem.total_processed"></dd></div>
                            <div><dt class="text-gray-500 dark:text-gray-400">Last heartbeat</dt><dd x-text="detailItem && detailItem.last_heartbeat"></dd></div>
                        </dl>
                    </div>
                </template>
                <template x-if="detailKind === 'event'">
                    <div class="p-6" x-data>
                        <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Event</h2>
                        <dl class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm" x-show="detailItem">
                            <div><dt class="text-gray-500 dark:text-gray-400">Event ID</dt><dd class="font-mono text-xs" x-text="detailItem && detailItem.event_id"></dd></div>
                            <div><dt class="text-gray-500 dark:text-gray-400">Topic</dt><dd><a :href="opsUrl({ tab: 'runtime', view: 'kafka' })" class="text-primary-600 dark:text-primary-400 hover:underline font-mono" x-text="detailItem && detailItem.topic"></a></dd></div>
                            <div><dt class="text-gray-500 dark:text-gray-400">Event name</dt><dd x-text="detailItem && detailItem.event_name"></dd></div>
                            <div><dt class="text-gray-500 dark:text-gray-400">Status</dt><dd><span class="px-2 py-0.5 rounded text-xs font-medium" :class="statusClass(detailItem && detailItem.status)" x-text="detailItem && detailItem.status"></span></dd></div>
                            <div><dt class="text-gray-500 dark:text-gray-400">Direction</dt><dd x-text="detailItem && detailItem.direction"></dd></div>
                        </dl>
                    </div>
                </template>
            </div>
        </div>

        <!-- List view (no selection) - full width -->
        <div x-show="!selected" x-cloak>
            <!-- Overview tab -->
            <div x-show="tab === 'overview'" x-cloak class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4">
                        <p class="text-xs font-semibold text-gray-400 uppercase">Tasks</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white mt-1" x-text="dashboard.tasks && dashboard.tasks.total"></p>
                        <p class="text-xs text-gray-500 mt-1">Success <span x-text="dashboard.tasks && dashboard.tasks.by_status && dashboard.tasks.by_status.SUCCESS"></span> · Failed <span x-text="dashboard.tasks && dashboard.tasks.by_status && dashboard.tasks.by_status.FAILURE"></span></p>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4">
                        <p class="text-xs font-semibold text-gray-400 uppercase">Workers</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white mt-1" x-text="dashboard.workers && dashboard.workers.total"></p>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4">
                        <p class="text-xs font-semibold text-gray-400 uppercase">Events</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white mt-1" x-text="dashboard.events && dashboard.events.total"></p>
                        <p class="text-xs text-gray-500 mt-1" x-text="(dashboard.events && dashboard.events.throughput_per_min) ? dashboard.events.throughput_per_min + '/min' : ''"></p>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4">
                        <p class="text-xs font-semibold text-gray-400 uppercase">Services</p>
                        <p class="text-sm text-gray-600 dark:text-gray-300 mt-1" x-text="(dashboard.infrastructure && dashboard.infrastructure.services && dashboard.infrastructure.services.length) ? dashboard.infrastructure.services.length + ' checked' : '—'"></p>
                    </div>
                </div>
            </div>

            <!-- Activity tab -->
            <div x-show="tab === 'activity'" x-cloak class="space-y-4">
                <div class="flex gap-2 mb-4">
                    <a :href="opsUrl({ tab: 'activity', view: 'tasks', selected: null })" @click.prevent="goTo({ tab: 'activity', view: 'tasks' })" :class="view === 'tasks' ? 'bg-primary-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200'" class="px-3 py-1.5 text-sm font-medium rounded-lg">Tasks</a>
                    <a :href="opsUrl({ tab: 'activity', view: 'workers', selected: null })" @click.prevent="goTo({ tab: 'activity', view: 'workers' })" :class="view === 'workers' ? 'bg-primary-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200'" class="px-3 py-1.5 text-sm font-medium rounded-lg">Workers</a>
                    <a :href="opsUrl({ tab: 'activity', view: 'periodic', selected: null })" @click.prevent="goTo({ tab: 'activity', view: 'periodic' })" :class="view === 'periodic' ? 'bg-primary-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200'" class="px-3 py-1.5 text-sm font-medium rounded-lg">Periodic</a>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm" x-show="view === 'tasks'">
                            <thead class="bg-gray-50 dark:bg-gray-700/50"><tr>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Task</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Queue</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Status</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Worker</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Created</th>
                            </tr></thead>
                            <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
                                <template x-for="item in activityItems" :key="item.task_id">
                                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/30">
                                        <td class="px-4 py-2"><a :href="opsUrl({ tab: 'activity', selected: item.task_id })" @click.prevent="goToSelected({ tab: 'activity', view: 'tasks', selected: item.task_id })" class="font-mono text-primary-600 dark:text-primary-400 hover:underline" x-text="item.task_name"></a></td>
                                        <td class="px-4 py-2 font-mono text-gray-600 dark:text-gray-400" x-text="item.queue"></td>
                                        <td class="px-4 py-2"><span class="px-2 py-0.5 rounded text-xs font-medium" :class="statusClass(item.status)" x-text="item.status"></span></td>
                                        <td class="px-4 py-2"><a :href="item.worker_id ? opsUrl({ tab: 'activity', view: 'workers', selected: item.worker_id }) : '#'" @click.prevent="item.worker_id && goToSelected({ tab: 'activity', view: 'workers', selected: item.worker_id })" class="font-mono text-primary-600 dark:text-primary-400 hover:underline truncate max-w-[120px] block" x-text="item.worker_id || '—'"></a></td>
                                        <td class="px-4 py-2 text-gray-500 text-xs" x-text="item.created_at ? item.created_at.slice(0,19) : ''"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                        <table class="w-full text-sm" x-show="view === 'workers'" x-cloak>
                            <thead class="bg-gray-50 dark:bg-gray-700/50"><tr>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Worker</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Status</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Active</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Processed</th>
                            </tr></thead>
                            <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
                                <template x-for="item in activityItems" :key="item.worker_id">
                                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/30">
                                        <td class="px-4 py-2"><a :href="opsUrl({ tab: 'activity', view: 'workers', selected: item.worker_id })" @click.prevent="goToSelected({ tab: 'activity', view: 'workers', selected: item.worker_id })" class="font-mono text-primary-600 dark:text-primary-400 hover:underline truncate max-w-[200px] block" x-text="item.worker_id"></a></td>
                                        <td class="px-4 py-2"><span class="px-2 py-0.5 rounded text-xs" :class="item.status === 'ONLINE' ? 'bg-green-100 dark:bg-green-900/30 text-green-700' : 'bg-gray-100 text-gray-600'" x-text="item.status"></span></td>
                                        <td class="px-4 py-2" x-text="item.active_tasks"></td>
                                        <td class="px-4 py-2" x-text="item.total_processed"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                        <table class="w-full text-sm" x-show="view === 'periodic'" x-cloak>
                            <thead class="bg-gray-50 dark:bg-gray-700/50"><tr>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Name</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Schedule</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Enabled</th>
                            </tr></thead>
                            <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
                                <template x-for="item in activityItems" :key="item.name">
                                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/30">
                                        <td class="px-4 py-2 font-medium" x-text="item.name"></td>
                                        <td class="px-4 py-2 text-gray-500" x-text="item.cron || item.interval || '—'"></td>
                                        <td class="px-4 py-2"><span class="px-2 py-0.5 rounded text-xs" :class="item.enabled ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'" x-text="item.enabled ? 'Yes' : 'No'"></span></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                    <div x-show="activityItems.length === 0 && !loading" class="px-4 py-12 text-center text-gray-500">No items</div>
                </div>
            </div>

            <!-- Stream tab (events) -->
            <div x-show="tab === 'stream'" x-cloak class="space-y-4">
                <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
                    <div class="px-4 py-3 border-b border-gray-100 dark:border-gray-700 flex items-center gap-4 flex-wrap">
                        <input type="text" x-model="filters.search" @input.debounce.300ms="applyFilters()" placeholder="Search..." class="rounded-lg border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-sm px-3 py-1.5 w-48">
                        <input type="text" x-model="filters.topic" @input.debounce.300ms="applyFilters()" placeholder="Topic" class="rounded-lg border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-sm px-3 py-1.5 w-40">
                    </div>
                    <div class="overflow-x-auto max-h-[60vh]">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 dark:bg-gray-700/50 sticky top-0">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Event</th>
                                    <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Topic</th>
                                    <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Status</th>
                                    <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Time</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
                                <template x-for="ev in streamItems" :key="ev.event_id">
                                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/30">
                                        <td class="px-4 py-2"><a :href="opsUrl({ tab: 'stream', selected: ev.event_id })" @click.prevent="goToSelected({ tab: 'stream', selected: ev.event_id })" class="font-mono text-primary-600 dark:text-primary-400 hover:underline text-xs truncate max-w-[180px] block" x-text="ev.event_id"></a></td>
                                        <td class="px-4 py-2"><a :href="opsUrl({ tab: 'runtime', view: 'kafka' })" class="text-primary-600 dark:text-primary-400 hover:underline font-mono text-xs" x-text="ev.topic"></a></td>
                                        <td class="px-4 py-2"><span class="px-2 py-0.5 rounded text-xs font-medium" :class="statusClass(ev.status)" x-text="ev.status"></span></td>
                                        <td class="px-4 py-2 text-gray-500 text-xs" x-text="ev.created_at ? ev.created_at.slice(0,19) : ''"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                    <template x-if="streamItems.length === 0 && !loading">
                        <div class="px-4 py-12 text-center text-gray-500">No events</div>
                    </template>
                </div>
            </div>

            <!-- Runtime tab -->
            <div x-show="tab === 'runtime'" x-cloak class="space-y-4">
                <div class="flex gap-2 mb-4">
                    <a :href="opsUrl({ tab: 'runtime', view: 'kafka' })" @click.prevent="goTo({ tab: 'runtime', view: 'kafka' })" :class="view === 'kafka' ? 'bg-primary-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200'" class="px-3 py-1.5 text-sm font-medium rounded-lg">Brokers / Kafka</a>
                    <a :href="opsUrl({ tab: 'runtime', view: 'logs' })" @click.prevent="goTo({ tab: 'runtime', view: 'logs' })" :class="view === 'logs' ? 'bg-primary-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200'" class="px-3 py-1.5 text-sm font-medium rounded-lg">Logs</a>
                </div>
                <div x-show="view === 'kafka'" class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4">
                    <p class="text-sm text-gray-600 dark:text-gray-300" x-text="system.kafka && system.kafka.enabled ? 'Cluster ID: ' + (system.kafka.cluster_id || '—') : 'Kafka not configured or disabled.'"></p>
                    <div class="mt-4 space-y-2" x-show="system.kafka && system.kafka.enabled">
                        <p class="text-xs text-gray-500">Topics: <span x-text="system.kafka.topics_count"></span> · Partitions: <span x-text="system.kafka.partitions_count"></span></p>
                    </div>
                </div>
                <div x-show="view === 'logs'" class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
                    <div class="px-4 py-3 border-b border-gray-100 dark:border-gray-700">Recent logs</div>
                    <div class="bg-gray-900 p-4 font-mono text-xs max-h-[50vh] overflow-y-auto">
                        <template x-for="(entry, idx) in logEntries" :key="idx">
                            <div class="py-0.5 flex gap-2">
                                <span class="text-gray-500 flex-shrink-0" x-text="(entry.timestamp || '').substring(11, 19)"></span>
                                <span class="flex-shrink-0 font-semibold text-green-400" x-text="entry.level"></span>
                                <span class="text-gray-300 truncate" x-text="entry.message"></span>
                            </div>
                        </template>
                        <template x-if="logEntries.length === 0 && !loading">
                            <div class="text-gray-500 py-4">No logs</div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('alpine:init', () => {
    const prefix = '{{ admin_prefix }}';
    const api = prefix + '/api/ops';
    const wsPath = (prefix + '/ws/ops/stream').replace(/^http/, 'ws').replace(/^https/, 'wss');
    const basePath = window.location.origin + (window.location.pathname.startsWith(prefix) ? prefix : '');

    function parseQuery() {
        const q = new URLSearchParams(window.location.search);
        return {
            tab: q.get('tab') || 'overview',
            view: q.get('view') || (q.get('tab') === 'activity' ? 'tasks' : q.get('tab') === 'runtime' ? 'kafka' : ''),
            selected: q.get('selected') || null,
            topic: q.get('topic') || '',
            search: q.get('search') || '',
        };
    }
    function buildQuery(params) {
        const cur = parseQuery();
        const p = { ...cur, ...params };
        const q = new URLSearchParams();
        if (p.tab && p.tab !== 'overview') q.set('tab', p.tab);
        if (p.view) q.set('view', p.view);
        if (p.selected) q.set('selected', p.selected);
        if (p.topic) q.set('topic', p.topic);
        if (p.search) q.set('search', p.search);
        const s = q.toString();
        return s ? '?' + s : '';
    }

    Alpine.data('opsCenter', () => ({
        tab: 'overview',
        view: 'tasks',
        selected: null,
        filters: { topic: '', search: '' },
        loading: false,
        realtimeEnabled: true,
        dashboard: {},
        activityItems: [],
        streamItems: [],
        logEntries: [],
        system: {},
        detailKind: null,
        detailItem: null,
        _ws: null,

        init() {
            const q = parseQuery();
            this.tab = q.tab;
            this.view = q.view || (this.tab === 'activity' ? 'tasks' : this.tab === 'runtime' ? 'kafka' : '');
            this.selected = q.selected;
            this.filters.topic = q.topic;
            this.filters.search = q.search;
            this.refreshCurrent();
            if (this.selected) this.loadDetail();
            this.connectWs();
            window.addEventListener('popstate', () => {
                const q = parseQuery();
                this.tab = q.tab;
                this.view = q.view;
                this.selected = q.selected;
                this.filters.topic = q.topic;
                this.filters.search = q.search;
                this.refreshCurrent();
                if (this.selected) this.loadDetail();
            });
        },

        opsUrl(overrides) {
            const cur = { tab: this.tab, view: this.view, selected: this.selected, ...overrides };
            return prefix + '/ops/' + buildQuery(cur);
        },

        pushState(overrides) {
            const cur = { tab: this.tab, view: this.view, selected: this.selected };
            Object.assign(this, overrides);
            const url = prefix + '/ops/' + buildQuery({ ...cur, ...overrides });
            history.replaceState(null, '', url);
        },

        goTo(overrides) {
            const viewDefault = overrides.tab === 'activity' ? 'tasks' : overrides.tab === 'runtime' ? 'kafka' : this.view;
            this.pushState({ ...overrides, selected: null, view: overrides.view !== undefined ? overrides.view : viewDefault });
            this.refreshCurrent();
        },

        goToSelected(overrides) {
            this.pushState(overrides);
            this.refreshCurrent();
            if (this.selected) this.loadDetail();
        },

        statusClass(s) {
            if (!s) return '';
            if (s === 'SUCCESS' || s === 'sent' || s === 'delivered') return 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400';
            if (s === 'FAILURE' || s === 'failed') return 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400';
            if (s === 'RUNNING' || s === 'pending') return 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400';
            return 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400';
        },

        async refreshCurrent() {
            this.loading = true;
            if (this.tab === 'overview') {
                try {
                    const r = await fetch(api + '/dashboard');
                    this.dashboard = await r.json();
                } catch (e) {}
            }
            if (this.tab === 'activity') {
                try {
                    const r = await fetch(api + '/activity?view=' + (this.view || 'tasks') + '&per_page=100');
                    const d = await r.json();
                    this.activityItems = d.items || [];
                } catch (e) { this.activityItems = []; }
            }
            if (this.tab === 'stream') {
                try {
                    let url = api + '/events?per_page=50';
                    if (this.filters.topic) url += '&topic=' + encodeURIComponent(this.filters.topic);
                    if (this.filters.search) url += '&search=' + encodeURIComponent(this.filters.search);
                    const r = await fetch(url);
                    const d = await r.json();
                    this.streamItems = d.items || [];
                } catch (e) { this.streamItems = []; }
            }
            if (this.tab === 'runtime') {
                try {
                    const r = await fetch(api + '/system');
                    this.system = await r.json();
                } catch (e) {}
                if (this.view === 'logs') {
                    try {
                        const r = await fetch(api + '/logs?limit=100');
                        const d = await r.json();
                        this.logEntries = (d.entries || []).map(e => typeof e === 'string' ? JSON.parse(e) : e);
                    } catch (e) { this.logEntries = []; }
                }
            }
            this.loading = false;
        },

        applyFilters() {
            this.pushState({ topic: this.filters.topic, search: this.filters.search });
            if (this.tab === 'stream') this.refreshCurrent();
        },

        async loadDetail() {
            if (!this.selected) return;
            this.detailKind = null;
            this.detailItem = null;
            try {
                const r = await fetch(api + '/activity/' + encodeURIComponent(this.selected));
                if (r.ok) {
                    const d = await r.json();
                    this.detailKind = d.kind;
                    this.detailItem = d.item;
                    return;
                }
            } catch (e) {}
            try {
                const r = await fetch(api + '/events/' + encodeURIComponent(this.selected));
                if (r.ok) {
                    const d = await r.json();
                    this.detailKind = 'event';
                    this.detailItem = d.item;
                }
            } catch (e) {}
        },

        async action(actionName) {
            if (!this.selected) return;
            try {
                const r = await fetch(api + '/activity/' + encodeURIComponent(this.selected) + '/action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: actionName }),
                });
                if (r.ok) {
                    this.pushState({ selected: null });
                    this.detailKind = null;
                    this.detailItem = null;
                    this.refreshCurrent();
                }
            } catch (e) {}
        },

        connectWs() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const url = protocol + '//' + window.location.host + prefix + '/ws/ops/stream';
            try {
                this._ws = new WebSocket(url);
                this._ws.onmessage = (ev) => {
                    try {
                        const msg = JSON.parse(ev.data);
                        if (msg.type === 'ping' || msg.type === 'connected') return;
                        this.refreshCurrent();
                        if (this.selected) this.loadDetail();
                    } catch (e) {}
                };
                this._ws.onclose = () => { this.realtimeEnabled = false; };
                this._ws.onopen = () => { this.realtimeEnabled = true; };
            } catch (e) { this.realtimeEnabled = false; }
        },
    }));
});
</script>
{% endblock %}
