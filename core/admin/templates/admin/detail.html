{% extends "admin/base.html" %}

{% block title %}{% if is_new %}New {{ admin.display_name }}{% else %}Edit {{ admin.display_name }}{% endif %}{% endblock %}
{% block page_title %}{% if is_new %}New {{ admin.display_name }}{% else %}Edit {{ admin.display_name }}{% endif %}{% endblock %}

{% block page_actions %}
<a href="{{ admin_prefix }}/{{ app_label }}/{{ model_name }}/"
   class="inline-flex items-center px-3 py-2 text-sm text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-200">
    <i data-lucide="arrow-left" class="w-4 h-4 mr-1.5"></i>
    Back to list
</a>
{% endblock %}

{% block content %}
<div x-data="detailView()" x-init="loadData()">
    
    <!-- Loading -->
    <div x-show="loading" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-8 text-center text-gray-500">
        <div class="inline-block w-6 h-6 border-2 border-gray-300 border-t-primary-600 rounded-full animate-spin"></div>
        <p class="mt-2 text-sm">Loading...</p>
    </div>
    
    <!-- Error -->
    <div x-show="error" x-cloak class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-6 text-center">
        <i data-lucide="alert-circle" class="w-8 h-8 text-red-400 mx-auto"></i>
        <p class="mt-2 text-red-600" x-text="error"></p>
    </div>
    
    <!-- Success message -->
    <div x-show="message" x-cloak x-transition
         class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-3 mb-4">
        <div class="flex items-center">
            <i data-lucide="check-circle" class="w-4 h-4 text-green-600 mr-2"></i>
            <span class="text-sm text-green-800 dark:text-green-200" x-text="message"></span>
        </div>
    </div>
    
    <!-- Form -->
    <div x-show="!loading && !error" x-cloak>
        <form @submit.prevent="save()" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg">
            <div class="p-6 space-y-6">
                <template x-for="field in fields" :key="field.name">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">
                            <span x-text="field.name.replace('_', ' ').replace(/\b\w/g, c => c.toUpperCase())"></span>
                            <template x-if="field.readonly">
                                <span class="ml-1 text-xs text-gray-400 font-normal">(read only)</span>
                            </template>
                        </label>
                        
                        <!-- Help text -->
                        <template x-if="field.help_text">
                            <p class="text-xs text-gray-500 dark:text-gray-400 mb-1" x-text="field.help_text"></p>
                        </template>
                        
                        <!-- Boolean field -->
                        <template x-if="field.type === 'boolean'">
                            <div class="flex items-center">
                                <input type="checkbox" 
                                       :checked="formData[field.name]"
                                       @change="formData[field.name] = $event.target.checked"
                                       :disabled="field.readonly"
                                       class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                                <span class="ml-2 text-sm text-gray-600 dark:text-gray-400" x-text="formData[field.name] ? 'Yes' : 'No'"></span>
                            </div>
                        </template>
                        
                        <!-- Text/textarea field -->
                        <template x-if="field.type === 'text'">
                            <textarea 
                                x-model="formData[field.name]"
                                :readonly="field.readonly"
                                rows="4"
                                class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary-500 disabled:bg-gray-100 dark:disabled:bg-gray-600"
                                :class="{ 'bg-gray-50 dark:bg-gray-700 cursor-not-allowed': field.readonly }"
                            ></textarea>
                        </template>
                        
                        <!-- JSON field -->
                        <template x-if="field.type === 'json'">
                            <textarea 
                                :value="JSON.stringify(formData[field.name], null, 2)"
                                @input="try { formData[field.name] = JSON.parse($event.target.value) } catch(e) {}"
                                :readonly="field.readonly"
                                rows="6"
                                class="w-full px-3 py-2 text-sm font-mono border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary-500"
                                :class="{ 'bg-gray-50 dark:bg-gray-700 cursor-not-allowed': field.readonly }"
                            ></textarea>
                        </template>
                        
                        <!-- Default input -->
                        <template x-if="!['boolean', 'text', 'json'].includes(field.type)">
                            <input 
                                :type="field.type === 'integer' || field.type === 'float' ? 'number' : field.type === 'datetime' ? 'datetime-local' : 'text'"
                                x-model="formData[field.name]"
                                :readonly="field.readonly"
                                class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary-500"
                                :class="{ 'bg-gray-50 dark:bg-gray-700 cursor-not-allowed': field.readonly }"
                            >
                        </template>
                    </div>
                </template>
            </div>
            
            <!-- Actions -->
            <div class="border-t border-gray-200 dark:border-gray-700 px-6 py-4 flex items-center justify-between">
                <div>
                    {% if not is_new and 'delete' in admin.permissions and 'delete' not in admin.exclude_actions %}
                    <button type="button" @click="deleteItem()"
                            class="text-sm text-red-600 hover:text-red-800 font-medium">
                        <i data-lucide="trash-2" class="w-3.5 h-3.5 inline mr-1"></i>
                        Delete
                    </button>
                    {% endif %}
                </div>
                <div class="flex gap-3">
                    <a href="{{ admin_prefix }}/{{ app_label }}/{{ model_name }}/"
                       class="px-4 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">
                        Cancel
                    </a>
                    {% if (is_new and 'add' in admin.permissions) or (not is_new and 'change' in admin.permissions) %}
                    <button type="submit" :disabled="saving"
                            class="px-4 py-2 text-sm bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-lg disabled:opacity-50">
                        <span x-show="!saving">{% if is_new %}Create{% else %}Save changes{% endif %}</span>
                        <span x-show="saving">Saving...</span>
                    </button>
                    {% endif %}
                </div>
            </div>
        </form>
    </div>
</div>

{% block extra_js %}
<script>
function detailView() {
    const isNew = {{ 'true' if is_new else 'false' }};
    
    return {
        formData: {},
        fields: [],
        loading: !isNew,
        saving: false,
        error: null,
        message: null,
        
        async loadData() {
            if (isNew) {
                // New item â€” field metadata injetado pelo template (sem fetch)
                const allFields = JSON.parse('{{ fields_json | safe }}');
                const editableNames = new Set(JSON.parse('{{ editable_fields_json | safe }}'));
                
                // Filtra: apenas campos editaveis e nao-PK para o form de criacao
                this.fields = allFields.filter(f => editableNames.has(f.name) && !f.primary_key);
                
                // Inicializa formData com defaults
                const defaults = {};
                for (const f of this.fields) {
                    if (f.type === 'boolean') defaults[f.name] = false;
                    else defaults[f.name] = '';
                }
                this.formData = defaults;
                this.loading = false;
                return;
            }
            
            try {
                const resp = await fetch('{{ admin_prefix }}/api/{{ app_label }}/{{ model_name }}/{{ pk }}');
                if (!resp.ok) {
                    this.error = 'Failed to load item';
                    return;
                }
                const data = await resp.json();
                this.formData = data.item;
                this.fields = data.fields;
            } catch (e) {
                this.error = 'Network error: ' + e.message;
            } finally {
                this.loading = false;
                this.$nextTick(() => { if (window.lucide) lucide.createIcons(); });
            }
        },
        
        async save() {
            this.saving = true;
            this.message = null;
            
            const url = isNew 
                ? '{{ admin_prefix }}/api/{{ app_label }}/{{ model_name }}'
                : '{{ admin_prefix }}/api/{{ app_label }}/{{ model_name }}/{{ pk }}';
            
            const method = isNew ? 'POST' : 'PUT';
            
            try {
                const resp = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.formData),
                });
                
                const data = await resp.json();
                
                if (resp.ok) {
                    this.message = data.message;
                    if (isNew && data.pk) {
                        // Redirect to edit view
                        window.location.href = '{{ admin_prefix }}/{{ app_label }}/{{ model_name }}/' + data.pk + '/';
                    } else if (data.item) {
                        this.formData = data.item;
                    }
                } else {
                    this.error = data.detail || 'Failed to save';
                }
            } catch (e) {
                this.error = 'Network error: ' + e.message;
            } finally {
                this.saving = false;
            }
        },
        
        async deleteItem() {
            if (!confirm('Are you sure you want to delete this {{ admin.display_name | lower }}?')) return;
            
            try {
                const resp = await fetch('{{ admin_prefix }}/api/{{ app_label }}/{{ model_name }}/{{ pk }}', {
                    method: 'DELETE',
                });
                if (resp.ok) {
                    window.location.href = '{{ admin_prefix }}/{{ app_label }}/{{ model_name }}/';
                } else {
                    const data = await resp.json();
                    this.error = data.detail || 'Failed to delete';
                }
            } catch (e) {
                this.error = 'Network error: ' + e.message;
            }
        }
    };
}
</script>
{% endblock %}
{% endblock %}
