{% extends "admin/base.html" %}

{% block title %}{% if is_new %}New {{ admin.display_name }}{% else %}Edit {{ admin.display_name }}{% endif %}{% endblock %}

{% block breadcrumbs %}
<div class="flex items-center gap-1.5 text-sm">
    <a href="{{ admin_prefix }}/" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
    </a>
    <svg class="w-3.5 h-3.5 text-gray-300 dark:text-gray-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
    <span class="text-gray-400 dark:text-gray-500">{{ app_label }}</span>
    <svg class="w-3.5 h-3.5 text-gray-300 dark:text-gray-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
    <a href="{{ admin_prefix }}/{{ app_label }}/{{ model_name }}/" class="text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">{{ admin.display_name_plural }}</a>
    <svg class="w-3.5 h-3.5 text-gray-300 dark:text-gray-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
    <span class="font-semibold text-gray-900 dark:text-gray-100">{% if is_new %}New{% else %}#{{ pk }}{% endif %}</span>
</div>
{% endblock %}

{% block page_actions %}
<a href="{{ admin_prefix }}/{{ app_label }}/{{ model_name }}/"
   class="inline-flex items-center px-3 py-2 text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-xl transition-all">
    <svg class="w-4 h-4 mr-1.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
    Back to list
</a>
{% endblock %}

{% block extra_head %}
<style>
    /* Fix dark mode input contrast — explicit text color on all form elements */
    input[type="text"],
    input[type="number"],
    input[type="email"],
    input[type="password"],
    input[type="url"],
    input[type="datetime-local"],
    input[type="date"],
    input[type="time"],
    textarea,
    select {
        color: #111827; /* gray-900 */
    }
    .dark input[type="text"],
    .dark input[type="number"],
    .dark input[type="email"],
    .dark input[type="password"],
    .dark input[type="url"],
    .dark input[type="datetime-local"],
    .dark input[type="date"],
    .dark input[type="time"],
    .dark textarea,
    .dark select {
        color: #f3f4f6; /* gray-100 */
    }
    /* Readonly inputs — dimmed */
    .dark input:read-only,
    .dark textarea:read-only {
        color: #9ca3af; /* gray-400 */
    }
    input:read-only,
    textarea:read-only {
        color: #6b7280; /* gray-500 */
    }
    /* Placeholder contrast fix */
    .dark input::placeholder,
    .dark textarea::placeholder {
        color: #6b7280; /* gray-500 */
    }
</style>
{% endblock %}

{% block content %}
<div x-data="detailView()" x-init="loadData()"
     @beforeunload.window="handleBeforeUnload($event)">
    
    <!-- Loading -->
    <div x-show="loading" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-12 text-center">
        <div class="inline-block w-7 h-7 border-2 border-gray-200 dark:border-gray-600 border-t-primary-600 rounded-full animate-spin"></div>
        <p class="mt-3 text-sm text-gray-400">Loading...</p>
    </div>
    
    <!-- Error -->
    <div x-show="error && !loading" x-cloak class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl p-8 text-center">
        <svg class="w-10 h-10 text-red-300 mx-auto" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
        <p class="mt-3 text-sm text-red-600 font-medium" x-text="error"></p>
    </div>
    
    <!-- Form -->
    <div x-show="!loading && !error" x-cloak>
        <form @submit.prevent="save()">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- Main Form Area (2/3 width) -->
                <div class="lg:col-span-2 space-y-6">
                    
                    <!-- Unsaved Changes Indicator -->
                    <div x-show="hasUnsavedChanges" x-cloak x-transition
                         class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-xl px-4 py-2.5 flex items-center">
                        <svg class="w-4 h-4 text-amber-500 mr-2 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                        <span class="text-sm text-amber-700 dark:text-amber-300">You have unsaved changes</span>
                    </div>
                    
                    <!-- Editable Fields Card -->
                    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl">
                        <div class="px-6 py-4 border-b border-gray-100 dark:border-gray-700">
                            <h3 class="text-sm font-semibold text-gray-900 dark:text-gray-100 flex items-center gap-2">
                                <svg class="w-4 h-4 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                                {% if is_new %}Create {{ admin.display_name }}{% else %}Edit Details{% endif %}
                            </h3>
                            <p class="text-xs text-gray-400 mt-1">
                                Fields marked with <span class="text-red-400">*</span> are required.
                                <span class="text-gray-300 dark:text-gray-600">Optional fields can be left empty.</span>
                            </p>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">
                                <template x-for="field in editableFields" :key="field.name">
                                    <div :class="{ 'md:col-span-2': field.type === 'text' || field.type === 'json' }">
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">
                                            <span x-text="getFieldLabel(field)"></span>
                                            <!-- Required indicator — respects create/edit context for virtual_password -->
                                            <template x-if="isFieldRequired(field)">
                                                <span class="text-red-400 ml-0.5">*</span>
                                            </template>
                                            <template x-if="!isFieldRequired(field) && !['password', 'password_hash', 'virtual_password'].includes(field.widget)">
                                                <span class="text-gray-400 dark:text-gray-500 text-xs font-normal ml-1">(optional)</span>
                                            </template>
                                            <!-- Lock icon for password/secret fields -->
                                            <template x-if="['password', 'password_hash', 'virtual_password'].includes(field.widget)">
                                                <span class="text-gray-400 dark:text-gray-500 text-xs font-normal ml-1">
                                                    <svg class="w-3 h-3 inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                                                    <span x-show="!isNewItem" class="text-[11px]">optional</span>
                                                </span>
                                            </template>
                                            <!-- Enum badge -->
                                            <template x-if="field.widget === 'choices'">
                                                <span class="text-indigo-400 dark:text-indigo-500 text-[10px] font-normal ml-1 uppercase tracking-wider">enum</span>
                                            </template>
                                        </label>
                                        
                                        <!-- Help text -->
                                        <template x-if="field.help_text">
                                            <p class="text-xs text-gray-400 dark:text-gray-500 mb-1.5" x-text="field.help_text"></p>
                                        </template>
                                        
                                        <!-- ═══ SMART WIDGETS ═══ -->
                                        
                                        <!-- Password / Password Hash — input type=password, never shows stored value -->
                                        <template x-if="field.widget === 'password' || field.widget === 'password_hash'">
                                            <div>
                                                <div class="relative">
                                                    <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none">
                                                        <svg class="w-4 h-4 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                                                    </div>
                                                    <input 
                                                        type="password"
                                                        x-model="formData[field.name]"
                                                        @input="markDirty()"
                                                        @focus="if(formData[field.name] === '••••••••') formData[field.name] = ''"
                                                        :required="field.required"
                                                        :placeholder="isNewItem ? 'Enter password' : 'Leave empty to keep current'"
                                                        autocomplete="new-password"
                                                        class="w-full pl-10 pr-4 py-2.5 text-sm border border-gray-200 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500 transition-all"
                                                    >
                                                </div>
                                                <p class="text-xs text-gray-400 mt-1" x-text="isNewItem ? 'Password will be hashed automatically' : 'Enter new password to change, or leave empty'"></p>
                                            </div>
                                        </template>
                                        
                                        <!-- Virtual Password — campo virtual para models com set_password() -->
                                        <template x-if="field.widget === 'virtual_password'">
                                            <div>
                                                <div class="relative">
                                                    <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none">
                                                        <svg class="w-4 h-4 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                                                    </div>
                                                    <input 
                                                        type="password"
                                                        x-model="formData[field.name]"
                                                        @input="markDirty()"
                                                        :required="isNewItem && field.required_on_create"
                                                        :placeholder="isNewItem ? 'Enter password (required)' : 'New password (leave empty to keep current)'"
                                                        autocomplete="new-password"
                                                        class="w-full pl-10 pr-4 py-2.5 text-sm border border-gray-200 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500 transition-all"
                                                    >
                                                </div>
                                                <div class="flex items-center gap-1.5 mt-1">
                                                    <svg class="w-3 h-3 text-emerald-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                                                    <p class="text-xs text-gray-400" x-text="isNewItem 
                                                        ? 'Password will be hashed via set_password()' 
                                                        : 'Leave empty to keep current password. Only fill to change.'"></p>
                                                </div>
                                            </div>
                                        </template>
                                        
                                        <!-- Secret / Token — masked, set-only -->
                                        <template x-if="field.widget === 'secret'">
                                            <div>
                                                <input 
                                                    type="password"
                                                    x-model="formData[field.name]"
                                                    @input="markDirty()"
                                                    @focus="if(formData[field.name] === '••••••••') formData[field.name] = ''"
                                                    :placeholder="isNewItem ? 'Enter value' : 'Leave empty to keep current'"
                                                    autocomplete="off"
                                                    class="w-full px-3.5 py-2.5 text-sm border border-gray-200 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500 transition-all"
                                                >
                                                <p class="text-xs text-gray-400 mt-1">Sensitive value — stored securely</p>
                                            </div>
                                        </template>
                                        
                                        <!-- Slug — auto-generates from source field -->
                                        <template x-if="field.widget === 'slug'">
                                            <div>
                                                <div class="flex gap-2">
                                                    <input 
                                                        type="text"
                                                        x-model="formData[field.name]"
                                                        @input="markDirty()"
                                                        :required="field.required"
                                                        placeholder="auto-generated-slug"
                                                        class="flex-1 px-3.5 py-2.5 text-sm font-mono border border-gray-200 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500 transition-all"
                                                    >
                                                    <template x-if="field.slug_source">
                                                        <button type="button" 
                                                                @click="formData[field.name] = slugify(formData[field.slug_source] || ''); markDirty()"
                                                                class="px-3 py-2.5 text-xs font-medium border border-gray-200 dark:border-gray-600 rounded-xl text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors whitespace-nowrap"
                                                                title="Generate from source field">
                                                            Generate
                                                        </button>
                                                    </template>
                                                </div>
                                                <template x-if="field.slug_source">
                                                    <p class="text-xs text-gray-400 mt-1">
                                                        Auto-generates from <span class="font-mono" x-text="field.slug_source"></span>
                                                    </p>
                                                </template>
                                            </div>
                                        </template>
                                        
                                        <!-- Email — input type=email with icon -->
                                        <template x-if="field.widget === 'email'">
                                            <div class="relative">
                                                <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none">
                                                    <svg class="w-4 h-4 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><polyline points="22,7 13.5,12.5 2,7"/></svg>
                                                </div>
                                                <input 
                                                    type="email"
                                                    x-model="formData[field.name]"
                                                    @input="markDirty()"
                                                    :required="field.required"
                                                    :placeholder="field.required ? 'user@example.com' : 'Optional email'"
                                                    class="w-full pl-10 pr-4 py-2.5 text-sm border border-gray-200 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500 transition-all"
                                                >
                                            </div>
                                        </template>
                                        
                                        <!-- URL — input type=url with icon + preview -->
                                        <template x-if="field.widget === 'url'">
                                            <div>
                                                <div class="relative">
                                                    <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none">
                                                        <svg class="w-4 h-4 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                                                    </div>
                                                    <input 
                                                        type="url"
                                                        x-model="formData[field.name]"
                                                        @input="markDirty()"
                                                        :required="field.required"
                                                        placeholder="https://example.com"
                                                        class="w-full pl-10 pr-4 py-2.5 text-sm border border-gray-200 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500 transition-all"
                                                    >
                                                </div>
                                                <template x-if="formData[field.name] && formData[field.name].startsWith('http')">
                                                    <a :href="formData[field.name]" target="_blank" rel="noopener" class="inline-flex items-center gap-1 text-xs text-primary-500 hover:text-primary-700 mt-1">
                                                        <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                                                        Open link
                                                    </a>
                                                </template>
                                            </div>
                                        </template>
                                        
                                        <!-- Color — color picker -->
                                        <template x-if="field.widget === 'color'">
                                            <div class="flex items-center gap-3">
                                                <input 
                                                    type="color"
                                                    :value="formData[field.name] || '#3B82F6'"
                                                    @input="formData[field.name] = $event.target.value; markDirty()"
                                                    class="w-10 h-10 rounded-lg border border-gray-200 dark:border-gray-600 cursor-pointer p-0.5"
                                                >
                                                <input 
                                                    type="text"
                                                    x-model="formData[field.name]"
                                                    @input="markDirty()"
                                                    placeholder="#3B82F6"
                                                    pattern="^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$"
                                                    class="flex-1 px-3.5 py-2.5 text-sm font-mono border border-gray-200 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500 transition-all"
                                                >
                                                <div class="w-8 h-8 rounded-lg border border-gray-200 dark:border-gray-600" 
                                                     :style="'background-color:' + (formData[field.name] || '#ccc')"></div>
                                            </div>
                                        </template>
                                        
                                        <!-- FK / Foreign Key — searchable dropdown -->
                                        <template x-if="field.widget === 'fk'">
                                            <div x-data="fkField(field)" class="relative"
                                                 @focusout="handleFocusOut($event)"
                                                 @mousedown="handleMouseDown($event)">
                                                <!-- Selected value display + clear -->
                                                <div class="relative">
                                                    <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none">
                                                        <svg class="w-4 h-4 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                                                    </div>
                                                    <input
                                                        type="text"
                                                        x-ref="fkInput"
                                                        x-model="searchQuery"
                                                        @focus="openDropdown()"
                                                        @mousedown="openDropdown()"
                                                        @input="onSearchInput()"
                                                        @keydown.escape="closeDropdown()"
                                                        @keydown.tab="closeDropdown()"
                                                        @keydown.arrow-down.prevent="highlightNext()"
                                                        @keydown.arrow-up.prevent="highlightPrev()"
                                                        @keydown.enter.prevent="selectHighlighted()"
                                                        :placeholder="selectedLabel || (field.required ? 'Search...' : 'Optional — search...')"
                                                        :class="selectedLabel ? 'pl-10 pr-10' : 'pl-10 pr-4'"
                                                        class="w-full py-2.5 text-sm border border-gray-200 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500 transition-all"
                                                    >
                                                    <!-- Clear button -->
                                                    <template x-if="selectedLabel">
                                                        <button type="button" @click="clearSelection()" 
                                                                class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                                                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                                                        </button>
                                                    </template>
                                                </div>
                                                
                                                <!-- Selected value chip -->
                                                <template x-if="selectedLabel && !isOpen">
                                                    <div class="mt-1.5 inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium bg-primary-50 dark:bg-primary-900/30 text-primary-700 dark:text-primary-300 rounded-lg border border-primary-200 dark:border-primary-800">
                                                        <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                                                        <span x-text="selectedLabel"></span>
                                                    </div>
                                                </template>
                                                
                                                <!-- Dropdown -->
                                                <div x-show="isOpen" x-cloak
                                                     x-transition:enter="transition ease-out duration-150"
                                                     x-transition:enter-start="opacity-0 -translate-y-1"
                                                     x-transition:enter-end="opacity-100 translate-y-0"
                                                     x-transition:leave="transition ease-in duration-100"
                                                     x-transition:leave-start="opacity-100"
                                                     x-transition:leave-end="opacity-0"
                                                     class="absolute z-50 mt-1 w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-xl shadow-lg max-h-60 overflow-y-auto">
                                                    
                                                    <!-- Loading -->
                                                    <div x-show="loading" class="px-4 py-3 text-center">
                                                        <div class="inline-block w-4 h-4 border-2 border-gray-200 dark:border-gray-600 border-t-primary-500 rounded-full animate-spin"></div>
                                                        <span class="ml-2 text-xs text-gray-400">Searching...</span>
                                                    </div>
                                                    
                                                    <!-- Results -->
                                                    <template x-if="!loading && options.length > 0">
                                                        <div class="py-1">
                                                            <template x-for="(opt, idx) in options" :key="opt.pk">
                                                                <button type="button"
                                                                        @mousedown.prevent
                                                                        @click="selectOption(opt)"
                                                                        @mouseenter="highlightedIdx = idx"
                                                                        class="w-full text-left px-4 py-2 text-sm transition-colors flex items-center gap-2"
                                                                        :class="idx === highlightedIdx 
                                                                            ? 'bg-primary-50 dark:bg-primary-900/30 text-primary-700 dark:text-primary-300' 
                                                                            : 'text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700'">
                                                                    <span class="flex-1 truncate" x-text="opt.display"></span>
                                                                    <span class="text-[10px] font-mono text-gray-400 flex-shrink-0" x-text="'#' + opt.pk"></span>
                                                                </button>
                                                            </template>
                                                        </div>
                                                    </template>
                                                    
                                                    <!-- Empty -->
                                                    <div x-show="!loading && options.length === 0 && searchQuery.length > 0" class="px-4 py-3 text-center">
                                                        <p class="text-xs text-gray-400">No results found</p>
                                                    </div>
                                                </div>
                                                
                                                <!-- FK info -->
                                                <template x-if="field.fk_app_label">
                                                    <p class="text-xs text-gray-400 mt-1">
                                                        Related to <span class="font-mono" x-text="field.fk_app_label + '.' + field.fk_model_name"></span>
                                                    </p>
                                                </template>
                                            </div>
                                        </template>
                                        
                                        <!-- Choices / Enum — select dropdown with predefined values -->
                                        <template x-if="field.widget === 'choices' && field.choices">
                                            <div>
                                                <div class="relative">
                                                    <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none">
                                                        <svg class="w-4 h-4 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6h16"/><path d="M4 12h16"/><path d="M4 18h16"/></svg>
                                                    </div>
                                                    <select 
                                                        x-model="formData[field.name]"
                                                        @change="markDirty()"
                                                        :required="field.required"
                                                        class="w-full pl-10 pr-10 py-2.5 text-sm border border-gray-200 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500 transition-all appearance-none cursor-pointer"
                                                    >
                                                        <template x-if="!field.required || !formData[field.name]">
                                                            <option value="">— Select —</option>
                                                        </template>
                                                        <template x-for="choice in field.choices" :key="choice.value">
                                                            <option :value="choice.value" x-text="choice.label" :selected="formData[field.name] == choice.value"></option>
                                                        </template>
                                                    </select>
                                                    <!-- Custom dropdown arrow -->
                                                    <div class="absolute inset-y-0 right-0 flex items-center pr-3.5 pointer-events-none">
                                                        <svg class="w-4 h-4 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                                                    </div>
                                                </div>
                                                <!-- Current value chip -->
                                                <template x-if="formData[field.name]">
                                                    <div class="mt-1.5 inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium bg-indigo-50 dark:bg-indigo-900/20 text-indigo-700 dark:text-indigo-300 rounded-lg border border-indigo-200 dark:border-indigo-800">
                                                        <span x-text="(field.choices.find(c => c.value == formData[field.name]) || {}).label || formData[field.name]"></span>
                                                    </div>
                                                </template>
                                            </div>
                                        </template>
                                        
                                        <!-- ═══ STANDARD WIDGETS ═══ -->
                                        
                                        <!-- Boolean field (toggle switch) -->
                                        <template x-if="field.widget === 'default' && field.type === 'boolean'">
                                            <label class="relative inline-flex items-center cursor-pointer mt-1">
                                                <input type="checkbox" 
                                                       :checked="formData[field.name]"
                                                       @change="formData[field.name] = $event.target.checked; markDirty()"
                                                       class="sr-only peer">
                                                <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary-500/20 rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary-600"></div>
                                                <span class="ml-2 text-sm text-gray-600 dark:text-gray-400" x-text="formData[field.name] ? 'Yes' : 'No'"></span>
                                            </label>
                                        </template>
                                        
                                        <!-- Text/textarea field -->
                                        <template x-if="field.widget === 'default' && field.type === 'text'">
                                            <textarea 
                                                x-model="formData[field.name]"
                                                @input="markDirty()"
                                                rows="4"
                                                :required="field.required"
                                                :placeholder="field.required ? 'Required' : 'Optional'"
                                                class="w-full px-3.5 py-2.5 text-sm border border-gray-200 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500 transition-all resize-y"
                                            ></textarea>
                                        </template>
                                        
                                        <!-- JSON field -->
                                        <template x-if="field.widget === 'default' && field.type === 'json'">
                                            <textarea 
                                                :value="JSON.stringify(formData[field.name], null, 2)"
                                                @input="try { formData[field.name] = JSON.parse($event.target.value); markDirty(); } catch(e) {}"
                                                rows="6"
                                                class="w-full px-3.5 py-2.5 text-sm font-mono border border-gray-200 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500 transition-all resize-y"
                                            ></textarea>
                                        </template>
                                        
                                        <!-- Datetime field -->
                                        <template x-if="field.widget === 'default' && field.type === 'datetime'">
                                            <input 
                                                type="datetime-local"
                                                :value="formatDatetimeLocal(formData[field.name])"
                                                @input="formData[field.name] = $event.target.value; markDirty()"
                                                :required="field.required"
                                                step="1"
                                                class="w-full px-3.5 py-2.5 text-sm border border-gray-200 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500 transition-all"
                                            >
                                        </template>
                                        
                                        <!-- Default input (string, integer, float, uuid, ip) — excludes special widgets -->
                                        <template x-if="field.widget === 'default' && !['boolean', 'text', 'json', 'datetime'].includes(field.type)">
                                            <input 
                                                :type="field.type === 'integer' || field.type === 'float' ? 'number' : 'text'"
                                                :step="field.type === 'float' ? 'any' : undefined"
                                                x-model="formData[field.name]"
                                                @input="markDirty()"
                                                :required="field.required"
                                                :placeholder="field.type === 'uuid' ? '550e8400-e29b-41d4-a716-446655440000' : (field.required ? 'Required' : 'Optional')"
                                                class="w-full px-3.5 py-2.5 text-sm border border-gray-200 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500 transition-all"
                                            >
                                        </template>
                                        
                                        <!-- Validation hint -->
                                        <template x-if="isFieldRequired(field) && !['password', 'password_hash', 'secret'].includes(field.widget) && (!formData[field.name] && formData[field.name] !== false && formData[field.name] !== 0)">
                                            <p class="text-xs text-amber-500 mt-1">This field is required</p>
                                        </template>
                                    </div>
                                </template>
                            </div>
                            
                            <!-- Empty editable fields -->
                            <div x-show="editableFields.length === 0" class="text-center py-6 text-gray-400 text-sm">
                                No editable fields for this model.
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Sidebar: Actions + Read-only Fields (1/3 width) -->
                <div class="space-y-6">
                    
                    <!-- Actions Card -->
                    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl">
                        <div class="px-5 py-4 border-b border-gray-100 dark:border-gray-700">
                            <h3 class="text-sm font-semibold text-gray-900 dark:text-gray-100">Actions</h3>
                        </div>
                        <div class="p-5 space-y-3">
                            {% if (is_new and 'add' in admin.permissions) or (not is_new and 'change' in admin.permissions) %}
                            <button type="submit" :disabled="saving"
                                    class="w-full inline-flex items-center justify-center px-4 py-2.5 bg-primary-600 hover:bg-primary-700 text-white text-sm font-medium rounded-xl transition-all shadow-sm hover:shadow-md hover:shadow-primary-600/20 disabled:opacity-60 disabled:cursor-not-allowed">
                                <template x-if="!saving">
                                    <span class="inline-flex items-center gap-1.5">
                                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                                        {% if is_new %}Create {{ admin.display_name }}{% else %}Save Changes{% endif %}
                                    </span>
                                </template>
                                <template x-if="saving">
                                    <span class="inline-flex items-center gap-2">
                                        <svg class="w-4 h-4 animate-spin" viewBox="0 0 24 24" fill="none"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
                                        Saving...
                                    </span>
                                </template>
                            </button>
                            {% endif %}
                            
                            <a href="{{ admin_prefix }}/{{ app_label }}/{{ model_name }}/"
                               class="w-full inline-flex items-center justify-center px-4 py-2.5 text-sm border border-gray-200 dark:border-gray-600 rounded-xl text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                Cancel
                            </a>
                            
                            {% if not is_new and 'delete' in admin.permissions and 'delete' not in admin.exclude_actions %}
                            <div class="pt-2 border-t border-gray-100 dark:border-gray-700">
                                <button type="button" @click="deleteItem()"
                                        class="w-full inline-flex items-center justify-center gap-1.5 px-4 py-2 text-sm text-red-600 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-xl transition-colors">
                                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                                    Delete {{ admin.display_name }}
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Read-only Metadata Card -->
                    <div x-show="readonlyFields.length > 0" x-cloak
                         class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl">
                        <div class="px-5 py-4 border-b border-gray-100 dark:border-gray-700">
                            <h3 class="text-sm font-semibold text-gray-900 dark:text-gray-100 flex items-center gap-2">
                                <svg class="w-4 h-4 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                                Metadata
                            </h3>
                        </div>
                        <div class="p-5 space-y-3.5">
                            <template x-for="field in readonlyFields" :key="field.name">
                                <div>
                                    <dt class="text-[11px] font-medium text-gray-400 dark:text-gray-500 uppercase tracking-wider" 
                                        x-text="getFieldLabel(field).toLowerCase()"></dt>
                                    <template x-if="['password', 'password_hash', 'secret', 'virtual_password'].includes(field.widget)">
                                        <dd class="mt-0.5 text-sm text-gray-400 dark:text-gray-500 italic">
                                            <span class="inline-flex items-center gap-1">
                                                <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                                                Hidden
                                            </span>
                                        </dd>
                                    </template>
                                    <template x-if="!['password', 'password_hash', 'secret', 'virtual_password'].includes(field.widget)">
                                        <dd class="mt-0.5 text-sm text-gray-900 dark:text-gray-100 font-mono break-all"
                                            x-text="formatDisplayValue(formData[field.name], field)"></dd>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

{% block extra_js %}
<script>
function detailView() {
    const isNew = {{ 'true' if is_new else 'false' }};
    
    return {
        formData: {},
        fields: [],
        editableFields: [],
        readonlyFields: [],
        loading: !isNew,
        saving: false,
        error: null,
        hasUnsavedChanges: false,
        _originalData: null,
        isNewItem: isNew,
        
        /** Determina se campo é obrigatório no contexto atual (create vs edit) */
        isFieldRequired(field) {
            const widget = field.widget || 'default';
            // Virtual password: required on create, optional on edit
            if (widget === 'virtual_password') {
                return this.isNewItem && (field.required_on_create !== false);
            }
            // Regular password/hash: never visually required (optional placeholder handles it)
            if (widget === 'password' || widget === 'password_hash') {
                return false;
            }
            // Widget override: required_on_create / required_on_edit
            if ('required_on_create' in field || 'required_on_edit' in field) {
                return this.isNewItem 
                    ? (field.required_on_create !== false)
                    : (field.required_on_edit === true);
            }
            return field.required;
        },
        
        /** Retorna label amigável para campo — suporta override via metadata */
        getFieldLabel(field) {
            // Explicit label override from widgets config
            if (field.label) return field.label;
            
            const name = field.name;
            const widget = field.widget || 'default';
            
            // Password fields: show friendly label
            if (widget === 'password_hash' || widget === 'password' || widget === 'virtual_password') {
                return 'Password';
            }
            // Default: humanize field name
            return name.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        },
        
        /** Gera slug a partir de uma string — remove acentos, lowercase, hifens */
        slugify(text) {
            if (!text) return '';
            return text
                .toString()
                .normalize('NFD')                   // Remove acentos
                .replace(/[\u0300-\u036f]/g, '')    // Remove diacritics
                .toLowerCase()
                .trim()
                .replace(/[^a-z0-9\s-]/g, '')      // Remove caracteres especiais
                .replace(/[\s_]+/g, '-')            // Espaços → hífens
                .replace(/-+/g, '-')                // Múltiplos hifens → um
                .replace(/^-+|-+$/g, '');           // Remove hífens no início/fim
        },
        
        markDirty() {
            if (this._originalData) {
                this.hasUnsavedChanges = JSON.stringify(this.formData) !== JSON.stringify(this._originalData);
            } else {
                this.hasUnsavedChanges = true;
            }
        },
        
        handleBeforeUnload(event) {
            if (this.hasUnsavedChanges) {
                event.preventDefault();
                event.returnValue = '';
            }
        },
        
        formatDisplayValue(val, field) {
            if (val === null || val === undefined) return '—';
            if (typeof val === 'boolean') return val ? 'Yes' : 'No';
            if (val === '••••••••') return '••••••••';
            // Enum: show label instead of raw value
            if (field && field.widget === 'choices' && field.choices) {
                const match = field.choices.find(c => c.value == val);
                if (match) return match.label;
            }
            return String(val);
        },
        
        /**
         * Converte ISO datetime ou datetime-local value para o formato
         * esperado por <input type="datetime-local"> (YYYY-MM-DDTHH:MM:SS)
         */
        formatDatetimeLocal(val) {
            if (!val) return '';
            try {
                // Se já está no formato datetime-local, retorna direto
                if (typeof val === 'string' && val.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}/)) {
                    // Remove timezone suffix se existir
                    return val.replace(/[Z+].*$/, '').substring(0, 19);
                }
                const d = new Date(val);
                if (isNaN(d.getTime())) return val;
                // Format: YYYY-MM-DDTHH:MM:SS
                return d.getFullYear() + '-' +
                    String(d.getMonth() + 1).padStart(2, '0') + '-' +
                    String(d.getDate()).padStart(2, '0') + 'T' +
                    String(d.getHours()).padStart(2, '0') + ':' +
                    String(d.getMinutes()).padStart(2, '0') + ':' +
                    String(d.getSeconds()).padStart(2, '0');
            } catch (e) {
                return val || '';
            }
        },
        
        categorizeFields(allFields, editableNames) {
            const editableSet = new Set(editableNames);
            this.editableFields = allFields.filter(f => editableSet.has(f.name) && !f.primary_key && !f.readonly);
            this.readonlyFields = allFields.filter(f => f.readonly || f.primary_key || !editableSet.has(f.name));
        },
        
        async loadData() {
            if (isNew) {
                const allFields = JSON.parse('{{ fields_json | safe }}');
                const editableNames = JSON.parse('{{ editable_fields_json | safe }}');
                
                this.fields = allFields;
                this.categorizeFields(allFields, editableNames);
                
                const defaults = {};
                for (const f of this.editableFields) {
                    if (f.type === 'boolean') defaults[f.name] = false;
                    else if (f.widget === 'password' || f.widget === 'password_hash' || f.widget === 'secret' || f.widget === 'virtual_password') defaults[f.name] = '';
                    else if (f.widget === 'choices' && f.choices && f.choices.length > 0 && f.required) defaults[f.name] = f.choices[0].value;
                    else defaults[f.name] = '';
                }
                this.formData = defaults;
                this._originalData = JSON.parse(JSON.stringify(defaults));
                this._setupSlugWatchers();
                this.loading = false;
                return;
            }
            
            try {
                const resp = await fetch('{{ admin_prefix }}/api/{{ app_label }}/{{ model_name }}/{{ pk }}');
                if (!resp.ok) {
                    this.error = 'Failed to load item';
                    return;
                }
                const data = await resp.json();
                this.formData = data.item;
                this.fields = data.fields;
                
                const editableNames = data.fields.filter(f => !f.readonly).map(f => f.name);
                this.categorizeFields(data.fields, editableNames);
                
                this._originalData = JSON.parse(JSON.stringify(data.item));
            } catch (e) {
                this.error = 'Network error: ' + e.message;
            } finally {
                this.loading = false;
                this.$nextTick(() => {
                    if (window.lucide) lucide.createIcons();
                    // Notify FK fields that formData is ready
                    window.dispatchEvent(new CustomEvent('formdata-loaded'));
                });
            }
        },
        
        _setupSlugWatchers() {
            // Para cada campo slug com slug_source, observa mudanças no source
            for (const f of this.editableFields) {
                if (f.widget === 'slug' && f.slug_source) {
                    const slugField = f.name;
                    const sourceField = f.slug_source;
                    this.$watch(`formData.${sourceField}`, (val) => {
                        // Só auto-gera se slug está vazio ou se é novo item
                        if (this.isNewItem && (!this.formData[slugField] || this.formData[slugField] === this.slugify(this._lastSlugSource || ''))) {
                            this.formData[slugField] = this.slugify(val || '');
                            this._lastSlugSource = val;
                        }
                    });
                }
            }
        },
        
        async save() {
            this.saving = true;
            this.error = null;
            
            const url = isNew 
                ? '{{ admin_prefix }}/api/{{ app_label }}/{{ model_name }}'
                : '{{ admin_prefix }}/api/{{ app_label }}/{{ model_name }}/{{ pk }}';
            
            const method = isNew ? 'POST' : 'PUT';
            
            // Build payload: only send editable fields
            // Skip empty optional fields — backend will apply defaults/NULL
            // Smart handling for passwords, secrets, and sensitive fields
            const payload = {};
            for (const f of this.editableFields) {
                const val = this.formData[f.name];
                const widget = f.widget || 'default';
                
                // Password/secret fields: skip if placeholder or empty (keep current)
                if (widget === 'password' || widget === 'password_hash' || widget === 'secret' || widget === 'virtual_password') {
                    if (!val || val === '••••••••' || val === '') continue;
                    payload[f.name] = val;
                    continue;
                }
                
                // Always include required fields
                if (f.required) {
                    payload[f.name] = val;
                    continue;
                }
                
                // Skip empty optional fields (let backend handle defaults)
                if (val === '' || val === null || val === undefined) {
                    continue;
                }
                
                payload[f.name] = val;
            }
            
            try {
                const resp = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                
                const data = await resp.json();
                
                if (resp.ok) {
                    this.hasUnsavedChanges = false;
                    if (isNew && data.pk) {
                        window.showToast('success', 'Created', '{{ admin.display_name }} created successfully');
                        setTimeout(() => {
                            window.location.href = '{{ admin_prefix }}/{{ app_label }}/{{ model_name }}/' + data.pk + '/';
                        }, 500);
                    } else {
                        window.showToast('success', 'Saved', 'Changes saved successfully');
                        if (data.item) {
                            this.formData = data.item;
                            this._originalData = JSON.parse(JSON.stringify(data.item));
                        }
                    }
                } else {
                    const errorMsg = typeof data.detail === 'object' 
                        ? (data.detail.message || data.detail.detail || data.detail.title || 'Validation error') 
                        : (data.detail || 'Failed to save');
                    window.showToast('error', 'Error', errorMsg);
                    this.error = errorMsg;
                }
            } catch (e) {
                window.showToast('error', 'Network Error', e.message);
                this.error = 'Network error: ' + e.message;
            } finally {
                this.saving = false;
            }
        },
        
        async deleteItem() {
            if (!confirm('Are you sure you want to delete this {{ admin.display_name | lower }}? This action cannot be undone.')) return;
            
            try {
                const resp = await fetch('{{ admin_prefix }}/api/{{ app_label }}/{{ model_name }}/{{ pk }}', {
                    method: 'DELETE',
                });
                if (resp.ok) {
                    this.hasUnsavedChanges = false;
                    window.showToast('success', 'Deleted', '{{ admin.display_name }} deleted successfully');
                    setTimeout(() => {
                        window.location.href = '{{ admin_prefix }}/{{ app_label }}/{{ model_name }}/';
                    }, 500);
                } else {
                    const data = await resp.json();
                    window.showToast('error', 'Error', data.detail || 'Failed to delete');
                }
            } catch (e) {
                window.showToast('error', 'Network Error', e.message);
            }
        }
    };
}

/**
 * FK Field — Searchable dropdown Alpine component.
 * 
 * Busca items do model relacionado via /api/{app}/{model}/autocomplete
 * com debounce e keyboard navigation.
 */
function fkField(field) {
    const adminPrefix = '{{ admin_prefix }}';
    let debounceTimer = null;
    
    return {
        searchQuery: '',
        selectedLabel: '',
        options: [],
        loading: false,
        isOpen: false,
        highlightedIdx: -1,
        _initialized: false,
        _resolvedPk: null,
        
        init() {
            // Try resolving immediately (covers case where formData is already loaded)
            this.$nextTick(() => {
                this._tryResolve();
            });
            
            // Listen for 'formdata-loaded' event dispatched by loadData()
            // This covers the common case where fkField inits before the API returns
            window.addEventListener('formdata-loaded', () => {
                this.$nextTick(() => {
                    this._tryResolve();
                });
            });
        },
        
        _tryResolve() {
            const currentVal = this.getFormValue();
            if (currentVal && currentVal !== '' && currentVal !== null && currentVal !== undefined) {
                // Only resolve once per unique PK value
                if (this._resolvedPk === currentVal) return;
                this._resolvedPk = currentVal;
                this.resolveCurrentLabel(currentVal);
            }
        },
        
        getFormValue() {
            // Access parent Alpine scope formData
            try {
                const scope = Alpine.closestDataStack(this.$el);
                for (const data of scope) {
                    if (data.formData && field.name in data.formData) {
                        return data.formData[field.name];
                    }
                }
            } catch(e) {}
            return null;
        },
        
        setFormValue(val) {
            try {
                const scope = Alpine.closestDataStack(this.$el);
                for (const data of scope) {
                    if (data.formData) {
                        data.formData[field.name] = val;
                        if (data.markDirty) data.markDirty();
                        break;
                    }
                }
            } catch(e) {}
        },
        
        async resolveCurrentLabel(pkVal) {
            if (!field.fk_app_label || !field.fk_model_name) {
                this.selectedLabel = String(pkVal);
                return;
            }
            try {
                const resp = await fetch(
                    `${adminPrefix}/api/${field.fk_app_label}/${field.fk_model_name}/${pkVal}`
                );
                if (resp.ok) {
                    const data = await resp.json();
                    if (data.item) {
                        const display = data.item[field.fk_display] || data.item.name || data.item.email || data.item.title || pkVal;
                        this.selectedLabel = `${display} — #${pkVal}`;
                    } else {
                        this.selectedLabel = `#${pkVal}`;
                    }
                } else {
                    this.selectedLabel = `#${pkVal}`;
                }
            } catch(e) {
                this.selectedLabel = `#${pkVal}`;
            }
        },
        
        // Tracks if a mousedown happened inside the component
        // (prevents focusout from closing dropdown when clicking options)
        _mouseInsideComponent: false,
        
        handleMouseDown(event) {
            // Flag that the click is inside the component
            this._mouseInsideComponent = true;
            setTimeout(() => { this._mouseInsideComponent = false; }, 200);
        },
        
        handleFocusOut(event) {
            // Only close if focus left the entire component
            // Use setTimeout to let the new focus target settle
            setTimeout(() => {
                if (this._mouseInsideComponent) return;
                // Check if the new active element is still inside this component
                const container = this.$el;
                if (!container.contains(document.activeElement)) {
                    this.closeDropdown();
                }
            }, 150);
        },
        
        openDropdown() {
            // Always open, never toggle
            this.isOpen = true;
            this.highlightedIdx = -1;
            if (this.options.length === 0) {
                this.fetchOptions('');
            }
        },
        
        closeDropdown() {
            this.isOpen = false;
            if (this.selectedLabel) {
                this.searchQuery = '';
            }
        },
        
        onSearchInput() {
            this.isOpen = true;
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                this.fetchOptions(this.searchQuery);
            }, 250);
        },
        
        async fetchOptions(query) {
            if (!field.fk_app_label || !field.fk_model_name) return;
            
            this.loading = true;
            try {
                const url = `${adminPrefix}/api/${field.fk_app_label}/${field.fk_model_name}/autocomplete?q=${encodeURIComponent(query)}&limit=20`;
                const resp = await fetch(url);
                if (resp.ok) {
                    const data = await resp.json();
                    this.options = data.items || [];
                } else {
                    this.options = [];
                }
            } catch(e) {
                this.options = [];
            } finally {
                this.loading = false;
            }
        },
        
        selectOption(opt) {
            this.setFormValue(opt.pk);
            this.selectedLabel = opt.label;
            this.searchQuery = '';
            this.isOpen = false;
        },
        
        clearSelection() {
            this.setFormValue(field.nullable ? null : '');
            this.selectedLabel = '';
            this.searchQuery = '';
            this.options = [];
            try {
                const scope = Alpine.closestDataStack(this.$el);
                for (const data of scope) {
                    if (data.markDirty) { data.markDirty(); break; }
                }
            } catch(e) {}
        },
        
        highlightNext() {
            if (this.highlightedIdx < this.options.length - 1) {
                this.highlightedIdx++;
            }
        },
        
        highlightPrev() {
            if (this.highlightedIdx > 0) {
                this.highlightedIdx--;
            }
        },
        
        selectHighlighted() {
            if (this.highlightedIdx >= 0 && this.highlightedIdx < this.options.length) {
                this.selectOption(this.options[this.highlightedIdx]);
            }
        }
    };
}
</script>
{% endblock %}
{% endblock %}
